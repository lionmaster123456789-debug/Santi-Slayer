<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <title>Santi Slayer - Evolution</title>
    <style>
        body { margin: 0; background: #1a1a1a; color: white; font-family: sans-serif; overflow: hidden; }
        canvas { background: #27ae60; display: block; }
        #ui { position: absolute; top: 10px; left: 10px; background: rgba(0,0,0,0.6); padding: 10px; border-radius: 8px; pointer-events: none; }
        .btn-back { position: absolute; top: 10px; right: 10px; padding: 10px; background: #e74c3c; color: white; text-decoration: none; border-radius: 5px; z-index: 100; }
        #upgrade-menu { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: #2c3e50; padding: 20px; border: 4px solid #f1c40f; display: none; text-align: center; border-radius: 15px; z-index: 200; }
        .upgrade-card { background: #34495e; margin: 10px; padding: 10px; cursor: pointer; border-radius: 5px; }
        .upgrade-card:hover { background: #1abc9c; }
    </style>
</head>
<body>

    <div id="ui">
        <div style="font-size: 20px;">Zeit: <span id="timer">0</span>s | Kills: <span id="score">0</span></div>
        <div>HP: <progress id="hpBar" value="100" max="100" style="width:200px;"></progress></div>
        <div id="skills-list" style="font-size: 12px; color: #f1c40f;">Skills: Keine</div>
    </div>

    <a href="https://rhinogamescom.wordpress.com" class="btn-back">Get Back</a>

    <div id="upgrade-menu">
        <h2>Fähigkeit wählen!</h2>
        <div id="upgrade-options"></div>
    </div>

    <canvas id="gameCanvas"></canvas>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const WORLD_SIZE = 4000;
        let canvasW, canvasH;
        function resize() { canvasW = canvas.width = window.innerWidth; canvasH = canvas.height = window.innerHeight; }
        window.addEventListener('resize', resize); resize();

        let player = { x: WORLD_SIZE/2, y: WORLD_SIZE/2, speed: 5, hp: 100, score: 0, startTime: Date.now() };
        let camera = { x: 0, y: 0 };
        let keys = {};
        let enemies = [], projectiles = [], environment = [], pets = [];
        let gameActive = true;
        let lastShot = 0;
        let lastLightning = 0;

        // Skills (Level 0 = nicht gelernt)
        let skills = { fireRate: 1, lightning: 0, bunny: 0 };

        // Bäume & Steine
        for(let i=0; i<80; i++) environment.push({ x: Math.random()*WORLD_SIZE, y: Math.random()*WORLD_SIZE, type: Math.random()>0.4?'tree':'stone' });

        window.addEventListener('keydown', e => keys[e.key.toLowerCase()] = true);
        window.addEventListener('keyup', e => keys[e.key.toLowerCase()] = false);

        function spawnEnemy() {
            if(!gameActive) return;
            let time = (Date.now() - player.startTime) / 1000;
            let x = player.x + (Math.random() - 0.5) * 1500;
            let y = player.y + (Math.random() - 0.5) * 1500;
            
            if(time > 60 && Math.random() > 0.7) { // BÄR
                enemies.push({ type: 'bear', x, y, hp: 10, speed: 1.5, size: 40 });
            } else if(time > 30) { // GROSSE SCHLANGE
                enemies.push({ type: 'snake', x, y, hp: 4, speed: 2.5, segments: Array(12).fill({x,y}), color: '#145a32' });
            } else { // KLEINE SCHLANGE
                enemies.push({ type: 'snake', x, y, hp: 1, speed: 3, segments: Array(6).fill({x,y}), color: '#2ecc71' });
            }
        }
        setInterval(spawnEnemy, 1200);

        function showUpgradeMenu() {
            gameActive = false;
            const menu = document.getElementById('upgrade-menu');
            const container = document.getElementById('upgrade-options');
            container.innerHTML = '';
            menu.style.display = 'block';

            let pool = [
                { id: 'fireRate', name: 'Schneller Schießen', lv: skills.fireRate },
                { id: 'lightning', name: 'Blitz-Attacke', lv: skills.lightning },
                { id: 'bunny', name: 'Kampf-Hase', lv: skills.bunny }
            ];

            pool.forEach(s => {
                if(s.lv < 5) {
                    let div = document.createElement('div');
                    div.className = 'upgrade-card';
                    div.innerHTML = `<b>${s.name}</b> (Level ${s.lv} -> ${s.lv+1})`;
                    div.onclick = () => applyUpgrade(s.id);
                    container.appendChild(div);
                }
            });
        }

        function applyUpgrade(id) {
            skills[id]++;
            document.getElementById('upgrade-menu').style.display = 'none';
            document.getElementById('skills-list').innerText = `Skills: Schuss Lv${skills.fireRate}, Blitz Lv${skills.lightning}, Hase Lv${skills.bunny}`;
            gameActive = true;
            window.focus(); // WICHTIG: Fokus zurück für Steuerung
            requestAnimationFrame(update);
        }

        function update() {
            if(!gameActive) return;
            let time = Math.floor((Date.now() - player.startTime) / 1000);
            document.getElementById('timer').innerText = time;

            // Movement
            if(keys['w'] && player.y > 0) player.y -= player.speed;
            if(keys['s'] && player.y < WORLD_SIZE) player.y += player.speed;
            if(keys['a'] && player.x > 0) player.x -= player.speed;
            if(keys['d'] && player.x < WORLD_SIZE) player.x += player.speed;

            camera.x = player.x - canvasW/2;
            camera.y = player.y - canvasH/2;

            // Auto-Schuss
            if(Date.now() - lastShot > (600 / skills.fireRate)) {
                let target = enemies[0];
                if(target) {
                    let angle = Math.atan2(target.y - player.y, target.x - player.x);
                    projectiles.push({ x: player.x, y: player.y, vx: Math.cos(angle)*10, vy: Math.sin(angle)*10 });
                }
                lastShot = Date.now();
            }

            // Blitz Skill (Level 1-5)
            if(skills.lightning > 0 && Date.now() - lastLightning > 3000 / skills.lightning) {
                let target = enemies[Math.floor(Math.random()*enemies.length)];
                if(target) {
                    target.hp -= 2;
                    lastLightning = Date.now();
                    // Blitz Zeichnen Effekt (kurzzeitig)
                    ctx.strokeStyle = 'cyan'; ctx.lineWidth = 4;
                    ctx.beginPath(); ctx.moveTo(player.x-camera.x, player.y-camera.y);
                    ctx.lineTo(target.x-camera.x, target.y-camera.y); ctx.stroke();
                }
            }

            // Hase Skill
            if(skills.bunny > 0 && pets.length < 1) pets.push({ x: player.x, y: player.y });

            // Enemies Update
            enemies.forEach((en, i) => {
                let dist = Math.hypot(player.x - en.x, player.y - en.y);
                let angle = Math.atan2(player.y - en.y, player.x - en.x);
                en.x += Math.cos(angle) * en.speed;
                en.y += Math.sin(angle) * en.speed;

                if(en.type === 'snake') {
                    en.segments.unshift({x: en.x, y: en.y});
                    en.segments.pop();
                }

                if(dist < 30) { player.hp -= 0.2; document.getElementById('hpBar').value = player.hp; }
                if(player.hp <= 0) location.reload();

                projectiles.forEach((p, pi) => {
                    if(Math.hypot(p.x - en.x, p.y - en.y) < 30) {
                        en.hp -= 1;
                        projectiles.splice(pi, 1);
                    }
                });

                if(en.hp <= 0) {
                    enemies.splice(i, 1); player.score++;
                    document.getElementById('score').innerText = player.score;
                    if(player.score % 15 === 0) showUpgradeMenu();
                }
            });

            projectiles.forEach((p, i) => { p.x += p.vx; p.y += p.vy; if(Math.hypot(p.x-player.x, p.y-player.y) > 1000) projectiles.splice(i,1); });

            draw();
            requestAnimationFrame(update);
        }

        function draw() {
            ctx.clearRect(0, 0, canvasW, canvasH);
            ctx.save(); ctx.translate(-camera.x, -camera.y);

            // Umwelt
            environment.forEach(obj => {
                ctx.fillStyle = obj.type === 'tree' ? '#145a32' : '#7f8c8d';
                ctx.beginPath(); ctx.arc(obj.x, obj.y, 25, 0, Math.PI*2); ctx.fill();
            });

            // Player
            ctx.fillStyle = '#3498db';
            ctx.beginPath(); ctx.arc(player.x, player.y, 20, 0, Math.PI*2); ctx.fill();

            // Gegner
            enemies.forEach(en => {
                if(en.type === 'snake') {
                    ctx.fillStyle = en.color;
                    en.segments.forEach(s => { ctx.beginPath(); ctx.arc(s.x, s.y, 10, 0, Math.PI*2); ctx.fill(); });
                } else if(en.type === 'bear') {
                    ctx.fillStyle = '#5d4037'; // Bären-Braun
                    ctx.beginPath(); ctx.arc(en.x, en.y, en.size, 0, Math.PI*2); ctx.fill();
                    ctx.beginPath(); ctx.arc(en.x-20, en.y-25, 15, 0, Math.PI*2); ctx.fill(); // Ohr L
                    ctx.beginPath(); ctx.arc(en.x+20, en.y-25, 15, 0, Math.PI*2); ctx.fill(); // Ohr R
                }
            });

            // Projectiles
            ctx.fillStyle = 'yellow';
            projectiles.forEach(p => { ctx.beginPath(); ctx.arc(p.x, p.y, 5, 0, Math.PI*2); ctx.fill(); });

            ctx.restore();
        }
        update();
    </script>
</body>
</html>
